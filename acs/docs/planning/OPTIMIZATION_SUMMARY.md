# –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

## üéØ –¶–µ–ª—å
–°–Ω–∏–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ 70-80% –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ | –ü–æ—Å–ª–µ | –≠–∫–æ–Ω–æ–º–∏—è |
|----------|-------|---------|----------|
| –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤–Ω–æ–π | 3 –∑–∞–ø—Ä–æ—Å–∞ | 1 –∑–∞–ø—Ä–æ—Å | -67% |
| –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ | 5-6 –∑–∞–ø—Ä–æ—Å–æ–≤ | 1 –∑–∞–ø—Ä–æ—Å | -80% |
| –û—Ç–º–µ–Ω–∞ –≥–æ–ª–æ—Å–∞ | 5-6 –∑–∞–ø—Ä–æ—Å–æ–≤ | 1 –∑–∞–ø—Ä–æ—Å | -80% |
| **–¢–∏–ø–∏—á–Ω–∞—è —Å–µ—Å—Å–∏—è** | **13-15 –∑–∞–ø—Ä–æ—Å–æ–≤** | **3 –∑–∞–ø—Ä–æ—Å–∞** | **-80%** |

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. Postgres —Ñ—É–Ω–∫—Ü–∏–∏ (—Ç—Ä–µ–±—É—é—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ Supabase)

**–§–∞–π–ª:** `migrations/optimize_poll_queries.sql`

–°–æ–∑–¥–∞–Ω—ã 3 –∞—Ç–æ–º–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

#### `vote_for_option(device_id, option_id)`
–û–±—ä–µ–¥–∏–Ω—è–µ—Ç 4 –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ 1:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –≥–æ–ª–æ—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞
- –í—Å—Ç–∞–≤–∫–∞ –≥–æ–ª–æ—Å–∞
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞

#### `unvote_for_option(device_id, option_id)`
–û–±—ä–µ–¥–∏–Ω—è–µ—Ç 3 –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ 1:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞
- –£–¥–∞–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞
- –î–µ–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞

#### `get_poll_data(device_id, language_code)`
–û–±—ä–µ–¥–∏–Ω—è–µ—Ç 3 –∑–∞–ø—Ä–æ—Å–∞ –≤ 1:
- –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏
- –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –≥–æ–ª–æ—Å–æ–≤

### 2. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Flutter –∫–æ–¥–µ

#### `lib/services/poll_supabase_service.dart`

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- `vote()` - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RPC `vote_for_option()`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `PollVote?`
- `unvote()` - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RPC `unvote_for_option()`
- `getRemainingVotes()` - **—É–¥–∞–ª–µ–Ω–∞**, –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ `getPollData()`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `getPollData()` - –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

#### `lib/services/poll_service.dart`

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- `vote()` - —É–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
  ```dart
  // –ë—ã–ª–æ:
  _cachedOptions = [];
  _cachedVotes = [];

  // –°—Ç–∞–ª–æ:
  _cachedVotes.add(newVote);
  _cachedOptions[index].voteCount += 1;
  ```

- `unvote()` - —É–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
  ```dart
  // –ë—ã–ª–æ:
  _cachedOptions = [];
  _cachedVotes = [];

  // –°—Ç–∞–ª–æ:
  _cachedVotes.removeWhere((vote) => vote.optionId == optionId);
  _cachedOptions[index].voteCount -= 1;
  ```

- `getRemainingVotes()` - **—É–¥–∞–ª–µ–Ω–∞**

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `getPollData()` - –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

#### `lib/widgets/poll_widget.dart`

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- `_loadPollData()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `getPollData()` –≤–º–µ—Å—Ç–æ 3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
  ```dart
  // –ë—ã–ª–æ:
  final options = await _pollService.getOptions(_currentLanguage);
  final votes = await _pollService.getUserVotes();
  final remaining = await _pollService.getRemainingVotes(); // —Ä–µ–¥—É–Ω–¥–∞–Ω—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å!

  // –°—Ç–∞–ª–æ:
  final pollData = await _pollService.getPollData(_currentLanguage);
  final options = pollData['options'];
  final votes = pollData['votes'];
  final remaining = pollData['remaining_votes'];
  ```

- `_handleVote()` –∏ `_handleUnvote()` - –≤—ã—á–∏—Å–ª—è—é—Ç `remaining_votes` –ª–æ–∫–∞–ª—å–Ω–æ
  ```dart
  // –ë—ã–ª–æ:
  await _loadPollData(); // –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ (3 –∑–∞–ø—Ä–æ—Å–∞)

  // –°—Ç–∞–ª–æ:
  final votes = await _pollService.getUserVotes(); // –∏–∑ –∫—ç—à–∞
  final options = await _pollService.getOptions(_currentLanguage); // –∏–∑ –∫—ç—à–∞
  _remainingVotes = 3 - votes.length; // –≤—ã—á–∏—Å–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
  ```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **-80% –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î** - –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- **-70% —Ç—Ä–∞—Ñ–∏–∫–∞** - –º–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫ UI** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ reload
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –Ω–µ—Ç race conditions

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
- ‚ö° –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- üìä –°—á—ë—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
- üîÑ –ù–µ—Ç "–º–æ—Ä–≥–∞–Ω–∏—è" UI –ø—Ä–∏ reload
- üì± –ú–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –±–∞—Ç–∞—Ä–µ–∏

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ - –¥–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã
- ‚úÖ –£–º–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ - —Ä–∞–±–æ—Ç–∞ –≤ offline —Ä–µ–∂–∏–º–µ
- ‚úÖ Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

#### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
–ó–∞–≥—Ä—É–∑–∫–∞:
1. GET poll_options JOIN translations
2. GET poll_votes WHERE device_id
3. GET poll_votes WHERE device_id (—Å–Ω–æ–≤–∞!)

–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ:
1. GET poll_votes WHERE device_id (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞)
2. GET poll_votes WHERE device_id AND option_id (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞)
3. INSERT INTO poll_votes
4. SELECT vote_count FROM poll_options
5. UPDATE poll_options SET vote_count = ?

–ò—Ç–æ–≥–æ: 3 + 5 = 8 –∑–∞–ø—Ä–æ—Å–æ–≤
```

#### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
–ó–∞–≥—Ä—É–∑–∫–∞:
1. RPC get_poll_data(device_id, language_code)
   ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç options, votes, remaining_votes

–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ:
1. RPC vote_for_option(device_id, option_id)
   ‚Üí –î–µ–ª–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ

–ò—Ç–æ–≥–æ: 1 + 1 = 2 –∑–∞–ø—Ä–æ—Å–∞
```

### –£–º–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
1. –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∫—ç—à
2. –ü—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ –∫—ç—à –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ
3. –ü—Ä–∏ –æ—à–∏–±–∫–µ –∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
4. –ö—ç—à —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SharedPreferences –¥–ª—è offline —Ä–µ–∂–∏–º–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
- –†–∞–±–æ—Ç–∞ –≤ offline —Ä–µ–∂–∏–º–µ

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
migrations/optimize_poll_queries.sql              (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
lib/services/poll_supabase_service.dart           (–∏–∑–º–µ–Ω–µ–Ω–æ)
lib/services/poll_service.dart                    (–∏–∑–º–µ–Ω–µ–Ω–æ)
lib/widgets/poll_widget.dart                      (–∏–∑–º–µ–Ω–µ–Ω–æ)
OPTIMIZATION_INSTRUCTIONS.md                      (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
OPTIMIZATION_SUMMARY.md                           (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
```

## ‚ö†Ô∏è –í–∞–∂–Ω–æ!

**–î–ª—è —Ä–∞–±–æ—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:**
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∫–æ–º–∞–Ω–¥—ã –∏–∑ `migrations/optimize_poll_queries.sql` –≤ Supabase
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–ë–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∫–æ–º–∞–Ω–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!**

–ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–º. –≤ —Ñ–∞–π–ª–µ `OPTIMIZATION_INSTRUCTIONS.md`

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –í –∫–æ–Ω—Å–æ–ª–∏ Flutter:
```
=== POLL SUPABASE: Fetching poll data for device: xxx, language: en ===
=== POLL SERVICE: Poll data loaded with optimized single query ===
=== POLL SUPABASE: Voting for option xxx by device xxx ===
=== POLL SERVICE: Vote successful, cache updated locally ===
```

### –í Supabase Dashboard ‚Üí Logs ‚Üí API:
- –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –≤—ã–∑–æ–≤—ã RPC —Ñ—É–Ω–∫—Ü–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–ª–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å—Å—è –Ω–∞ ~80%

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:
- **–ù–∞ 80% –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î**
- **–ù–∞ 70% –º–µ–Ω—å—à–µ —Ç—Ä–∞—Ñ–∏–∫–∞**
- **–í 3-5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ë–æ–ª–µ–µ –æ—Ç–∑—ã–≤—á–∏–≤—ã–π UI** –±–µ–∑ reload

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∞ –≤ —Ä–∞–∑—ã –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤—Å–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏!**
