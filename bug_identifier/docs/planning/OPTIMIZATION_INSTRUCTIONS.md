# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –≤ –∫–æ–¥–µ

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Flutter –∫–æ–¥–µ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:

1. ‚úÖ `lib/services/poll_supabase_service.dart` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RPC –≤—ã–∑–æ–≤—ã
2. ‚úÖ `lib/services/poll_service.dart` - —É–º–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
3. ‚úÖ `lib/widgets/poll_widget.dart` - –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ remaining votes –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é –≤ Supabase

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://supabase.com/dashboard
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor** (–ª–µ–≤–æ–µ –º–µ–Ω—é)

### –®–∞–≥ 2: –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∫–æ–º–∞–Ω–¥—ã

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ **–í–ï–°–¨** –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ `migrations/optimize_poll_queries.sql` –≤ SQL Editor.

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–∑–¥–∞—Å—Ç 3 —Ñ—É–Ω–∫—Ü–∏–∏:
- `vote_for_option()` - –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
- `unvote_for_option()` - –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –≥–æ–ª–æ—Å–∞
- `get_poll_data()` - –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–ª–∏—Å—å

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π
SELECT routine_name
FROM information_schema.routines
WHERE routine_name IN ('vote_for_option', 'unvote_for_option', 'get_poll_data');
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤—Å–µ 3 —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö.

### –®–∞–≥ 4: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ó–∞–º–µ–Ω–∏—Ç–µ `your-device-id-here` –∏ `your-option-id-here` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ UUID –∏–∑ –≤–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

```sql
-- –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–æ—Å–∞
SELECT get_poll_data(
  'your-device-id-here'::uuid,
  'en'
);

-- –¢–µ—Å—Ç 2: –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
SELECT vote_for_option(
  'your-device-id-here'::uuid,
  'your-option-id-here'::uuid
);

-- –¢–µ—Å—Ç 3: –û—Ç–º–µ–Ω–∞ –≥–æ–ª–æ—Å–∞
SELECT unvote_for_option(
  'your-device-id-here'::uuid,
  'your-option-id-here'::uuid
);
```

### –®–∞–≥ 5: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∫–æ–º–∞–Ω–¥ –≤ Supabase:

```bash
flutter clean
flutter pub get
flutter run
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤–Ω–æ–π: **3 –∑–∞–ø—Ä–æ—Å–∞**
- –û–¥–Ω–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: **5-6 –∑–∞–ø—Ä–æ—Å–æ–≤**
- –û—Ç–º–µ–Ω–∞ –≥–æ–ª–æ—Å–∞: **5-6 –∑–∞–ø—Ä–æ—Å–æ–≤**
- **–í—Å–µ–≥–æ: 13-15 –∑–∞–ø—Ä–æ—Å–æ–≤** –Ω–∞ —Ç–∏–ø–∏—á–Ω—É—é —Å–µ—Å—Å–∏—é

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤–Ω–æ–π: **1 –∑–∞–ø—Ä–æ—Å** (-67%)
- –û–¥–Ω–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: **1 –∑–∞–ø—Ä–æ—Å** (-80%)
- –û—Ç–º–µ–Ω–∞ –≥–æ–ª–æ—Å–∞: **1 –∑–∞–ø—Ä–æ—Å** (-80%)
- **–í—Å–µ–≥–æ: 3 –∑–∞–ø—Ä–æ—Å–∞** (-80%)

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (–Ω–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è reload)
- ‚úÖ –°—á—ë—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
- ‚úÖ –ú–µ–Ω—å—à–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
- ‚úÖ UI –±–æ–ª–µ–µ –æ—Ç–∑—ã–≤—á–∏–≤
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ ~70-80%

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é

### –í –∫–æ–Ω—Å–æ–ª–∏ Flutter (Debug mode):

–ò—â–∏—Ç–µ –ª–æ–≥–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `=== POLL`:

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
=== POLL SUPABASE: Fetching options for language: en ===
=== POLL SUPABASE: Fetching votes for device: xxx ===
=== POLL SUPABASE: Fetching votes for device: xxx ===  (getRemainingVotes)
```

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
=== POLL SUPABASE: Fetching poll data for device: xxx, language: en ===
=== POLL SERVICE: Poll data loaded with optimized single query ===
```

### –í Supabase Logs:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Supabase Dashboard ‚Üí Logs ‚Üí API
2. –û—Ç—Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ –≤–∞—à–µ–º—É device_id
3. –ü–æ—Å—á–∏—Ç–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏

## ‚ùó –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: "Function does not exist"

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ SQL –∫–æ–º–∞–Ω–¥—ã –∏–∑ —Ñ–∞–π–ª–∞ `migrations/optimize_poll_queries.sql` –≤ Supabase SQL Editor.

### –ü—Ä–æ–±–ª–µ–º–∞: "Permission denied"

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS (Row Level Security) –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase. –§—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—ã `poll_votes` –∏ `poll_options`.

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor:

```sql
-- –î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π authenticated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
GRANT EXECUTE ON FUNCTION vote_for_option TO authenticated;
GRANT EXECUTE ON FUNCTION unvote_for_option TO authenticated;
GRANT EXECUTE ON FUNCTION get_poll_data TO authenticated;

-- –î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –∞–Ω–æ–Ω–∏–º–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
GRANT EXECUTE ON FUNCTION vote_for_option TO anon;
GRANT EXECUTE ON FUNCTION unvote_for_option TO anon;
GRANT EXECUTE ON FUNCTION get_poll_data TO anon;
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

```bash
flutter clean
flutter pub get
flutter run
```

–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏.

## üìù –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

```bash
git checkout claude/optimize-db-queries-011CUtJfBXCcXxZX4syCSR5d~1
```

–ò–ª–∏ –æ—Ç–∫–∞—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ SQL —Ñ—É–Ω–∫—Ü–∏–∏ –≤ Supabase:

```sql
DROP FUNCTION IF EXISTS vote_for_option;
DROP FUNCTION IF EXISTS unvote_for_option;
DROP FUNCTION IF EXISTS get_poll_data;
```

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Supabase Dashboard
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å
   - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è RPC —Ñ—É–Ω–∫—Ü–∏–π

2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ö—ç—à —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SharedPreferences
   - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –ö—ç—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –≤ offline —Ä–µ–∂–∏–º–µ
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## ‚úÖ Checklist

- [ ] –í—ã–ø–æ–ª–Ω–∏–ª SQL –∫–æ–º–∞–Ω–¥—ã –≤ Supabase SQL Editor
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–ª–∏—Å—å (`SELECT routine_name...`)
- [ ] –ó–∞–ø—É—Å—Ç–∏–ª `flutter clean && flutter pub get`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª –∑–∞–≥—Ä—É–∑–∫—É –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª –æ—Ç–º–µ–Ω—É –≥–æ–ª–æ—Å–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ Flutter
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Supabase Dashboard
- [ ] –£–±–µ–¥–∏–ª—Å—è, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

## üéâ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 70-80% –±—ã—Å—Ç—Ä–µ–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ –ë–î!
